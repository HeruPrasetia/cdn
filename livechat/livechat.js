let __DataChat=[],typingTimeout=!1,__Setting={},host=window.location.hostname;function GI(e){return document.getElementById(e)}function playSound(){new Audio("https://wapi.naylatools.com/file/bell.mp3").play().catch(e=>console.warn("Gagal play sound:",e))}function connectWebSocket(a){return new Promise((e,t)=>{var n="localhost"==window.location.hostname?"ws://localhost:3003/":"wss://ws.naylatools.com/";const s=new WebSocket(n+`?token=${a}&domain=${sessionStorage.getItem("domain-server")}&usertype=Client&devicekey=`+sessionStorage.getItem("device-key"));s.onopen=()=>{console.log("WebSocket connected!"),s.send(JSON.stringify({type:"list chat client"})),e(s)},s.onerror=e=>{console.error("WebSocket error:",e),t(e)},s.onclose=()=>{console.warn("WebSocket closed")},s.onmessage=e=>{document.getElementById("chatToggleBtn").classList.add("bounce2");var e=JSON.parse(e.data),t=e.type;"detail chat client"==t?(__DataChat=e.data,handleRendBuble(),scrollToBottom()):"pesan dari admin"==t&&(playSound(),__DataChat.push(e),addBubble(e),scrollToBottom())}})}function rendElm(e){var t,n=e.to||null;let s=document.createDocumentFragment();if(e.elm.forEach(e=>{e=function n(s){let a=document.createElement(s.elm);return Object.keys(s).forEach(e=>{if("elm"!==e)if("text"===e)a.textContent=s.text;else if("html"===e)a.innerHTML=s.html;else if("cls"===e)a.className=s.cls;else if("attr"===e)for(var t in s.attr)a.setAttribute(t,s.attr[t]);else"selected"===e&&!0===s.selected?a.selected=!0:"checked"===e&&!0===s.checked?a.checked=!0:"style"===e?a.style.cssText=s.style:"elms"===e?s.elms.forEach(e=>{e=n(e),a.appendChild(e)}):a.setAttribute(e,s[e])}),a}(e);s.appendChild(e)}),!n)return(t=document.createElement("div")).appendChild(s),t.innerHTML;(t=document.querySelector(n))&&(e.add||(t.innerHTML=""),t.appendChild(s))}async function RendLiveChat(){var e=sessionStorage.getItem("TokenUserLC");e?(rendElm({to:"#divLiveChat",add:!1,elm:[{elm:"div",cls:"floating-btn",id:"chatToggleBtn",elms:["none"==__Setting.maskot?{elm:"button",cls:"floating-btn"}:{elm:"img",src:__Setting.maskot,style:"width:100%"}]},{elm:"div",cls:"floating-chat",id:"chatBox",style:"display:none;",elms:[{elm:"div",cls:"chat-header",text:__Setting.title},{elm:"div",cls:"chat-body",id:"chatMessages"},{elm:"div",cls:"chat-input",elms:[{elm:"input",type:"text",cls:"form-input",id:"chatInput",placeholder:"Tulis pesan..."},{elm:"button",text:"Kirim",cls:"btn-chat",id:"sendBtn"}]}]}]}),e=await connectWebSocket(e),window.ws=e,GI("chatInput").addEventListener("keydown",e=>{"Enter"===e.key?(this.handleSend(),this.typingTimeout&&clearTimeout(typingTimeout),window.ws.send(JSON.stringify({type:"stop_typing_client"}))):(window.ws.send(JSON.stringify({type:"typing"})),this.typingTimeout&&clearTimeout(this.typingTimeout),this.typingTimeout=setTimeout(()=>{window.ws.send(JSON.stringify({type:"stop_typing_client"}))},1500))}),GI("sendBtn").addEventListener("click",()=>handleSend())):(rendElm({to:"#divLiveChat",add:!1,elm:[{elm:"div",cls:"floating-btn",id:"chatToggleBtn",elms:["none"==__Setting.maskot?{elm:"button",cls:"floating-btn"}:{elm:"img",src:__Setting.maskot,style:"width:100%"}]},{elm:"div",cls:"floating-chat",id:"chatBox",style:"display:none;",elms:[{elm:"div",cls:"chat-header",text:__Setting.title},{elm:"div",id:"chatMessages",style:"padding:10px",elms:[{elm:"label",text:"Silahkan masukan data anda"},{elm:"p"},{elm:"div",cls:"form-group",elms:[{elm:"label",text:"Nama"},{elm:"input",type:"text",cls:"form-input",id:"edtNama",placeholder:"Masukan Nama"}]},{elm:"div",cls:"form-group",elms:[{elm:"label",text:"ALamat Email"},{elm:"input",type:"email",cls:"form-input",id:"edtEmail",placeholder:"Masukan Alamat Email"}]},{elm:"div",cls:"form-group",elms:[{elm:"label",text:"No WHatsApp"},{elm:"input",type:"text",cls:"form-input",id:"edtTelp",placeholder:"Masukan No WhatsApp"}]},{elm:"button",cls:"btn-chat",id:"btnLogin",style:"width:100%; display:flex;  justify-content: center; align-items: center;",elms:[{elm:"div",cls:"typing-indicator",id:"divLoading",style:"display:none",elms:[{elm:"span"},{elm:"span"},{elm:"span"}]},{elm:"span",text:"Mulai Chat"}]}]}]}]}),GI("btnLogin").addEventListener("click",async e=>{try{var s=GI("edtNama").value;if(""==s)return showToast("Silahkan isi Nama anda");var a=GI("edtEmail").value;if(""==a)return showToast("Silahkan isi Alamat Email anda");var l=GI("edtTelp").value;if(""==l)return showToast("Silahkan isi no WhatsApp anda");let t=e.target,n=(t.disabled=!0,GI("divLoading"));n.style.display="flex",fetch(encodeURI("localhost"==host?"http://localhost:3001/loginlivechat":"https://wapi.naylatools.com/loginlivechat"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({Nama:s,Email:a,Telp:l,ClientKey:sessionStorage.getItem("client-key"),DeviceKey:sessionStorage.getItem("device-key"),Domain:host})}).then(e=>e.text()).then(async e=>{"localhost"===host&&console.log(e);var e=JSON.parse(e);"sukses"==e.status&&(sessionStorage.setItem("TokenUserLC",e.token),e=await connectWebSocket(e.Token),window.ws=e,t.disabled=!1,rendElm({to:"#chatBox",add:!(n.style.display="none"),elm:[{elm:"div",cls:"chat-header",text:__Setting.title},{elm:"div",cls:"chat-body",id:"chatMessages"},{elm:"div",cls:"chat-input",elms:[{elm:"input",type:"text",cls:"form-input",id:"chatInput",placeholder:"Tulis pesan..."},{elm:"button",text:"Kirim",cls:"btn-chat",id:"sendBtn"}]}]}),GI("chatInput").addEventListener("keydown",e=>{"Enter"===e.key?(this.handleSend(),this.typingTimeout&&clearTimeout(typingTimeout),window.ws.send(JSON.stringify({type:"stop_typing_client"}))):(window.ws.send(JSON.stringify({type:"typing"})),this.typingTimeout&&clearTimeout(this.typingTimeout),this.typingTimeout=setTimeout(()=>{window.ws.send(JSON.stringify({type:"stop_typing_client"}))},1500))}),GI("sendBtn").addEventListener("click",()=>handleSend()))})}catch(e){console.error("WebSocket connection failed:",e),btn.disabled=!1,load.style.display="none"}})),document.addEventListener("click",function(e){var t=GI("chatBox"),n=GI("chatToggleBtn");t&&n&&(e.target.closest("#chatToggleBtn")?(t.style.display="none"===t.style.display||""===t.style.display?"block":"none",GI("chatToggleBtn").classList.remove("bounce2")):t.contains(e.target)||"block"!==t.style.display||(t.style.display="none"))})}function showToast(e,t=3e3){const n=document.getElementById("DivToastLC");n&&(n.textContent=e,n.classList.add("show"),setTimeout(()=>{n.classList.remove("show")},t))}!async function(){var e=document.currentScript,t=e.getAttribute("client-key"),n=e.getAttribute("device-key"),e=e.getAttribute("domain-server");if(t){var s=document.createElement("link"),s=(s.rel="stylesheet",s.type="text/css",s.href="localhost"==host?"./livechat.css":"https://cdn.jsdelivr.net/gh/HeruPrasetia/cdn/livechat/livechat.css",document.head.appendChild(s),document.createElement("div")),s=(s.id="divLiveChat",document.body.appendChild(s),document.createElement("div")),s=(s.id="DivToastLC",s.className="toast",document.body.appendChild(s),sessionStorage.setItem("client-key",t),sessionStorage.setItem("device-key",n),sessionStorage.setItem("domain-server",e),sessionStorage.getItem("FirstCome")||"YA");"YA"==s&&sessionStorage.setItem("FirstCome",Date.now());try{fetch(encodeURI("localhost"==host?"http://localhost:3001/detaillivechat":"https://wapi.naylatools.com/detaillivechat"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ClientKey:t,DeviceKey:n,FirstCome:s,Domain:host})}).then(e=>e.text()).then(async e=>{e=JSON.parse(e);"sukses"==e.status&&(__Setting=e.Device.Setting,document.documentElement.style.setProperty("--color-primary",__Setting.color),RendLiveChat())})}catch(e){console.error("WebSocket connection failed:",e)}}else console.warn("client-key attribute not found on script tag!")}();const tanggalIndo=function(e,t=!1){e=new Date(e);if(isNaN(e.getTime()))return"";var n=[e.getFullYear(),("0"+(e.getMonth()+1)).slice(-2),("0"+e.getDate()).slice(-2)].join("-");if("0000-00-00"===n||null==n)return n;var s=n.substring(8,10),a=n.substring(5,7),n=n.substring(2,4);let l=`${s} ${["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"][parseInt(a,10)-1]} `+n;return!0===t&&(s=("0"+e.getHours()).slice(-2),a=("0"+e.getMinutes()).slice(-2),n=("0"+e.getSeconds()).slice(-2),l+=` ${s}:${a}:`+n),l};function scrollToBottom(){var e=document.getElementById("chatMessages");e&&e.scrollTo({top:e.scrollHeight,behavior:"smooth"})}function handleSend(){var e=GI("chatInput").value;""!=e&&(__DataChat.push({UserType:"Client",Pesan:e,Waktu:Date.now()}),window.ws.send(JSON.stringify({type:"pesan ke admin",pesan:e})),GI("chatInput").value="",addBubble({UserType:"Client",Pesan:e,Waktu:Date.now()}),scrollToBottom())}function handleRendBuble(){rendElm({to:"#chatMessages",add:!1,elm:__DataChat.map((e,t)=>({elm:"div",cls:"Client"==e.UserType?"chat-message chat-message-user":"chat-message chat-message-me",elms:[{elm:"span",text:e.Pesan,style:"font-size:15px"},{elm:"br"},{elm:"b",style:"font-size:10px",text:tanggalIndo(e.Waktu,!0)}]}))})}function addBubble(e){rendElm({to:"#chatMessages",add:!0,elm:[{elm:"div",cls:"Client"==e.UserType?"chat-message chat-message-user":"chat-message chat-message-me",elms:[{elm:"span",text:e.Pesan,style:"font-size:15px"},{elm:"br"},{elm:"b",style:"font-size:10px",text:tanggalIndo(e.Waktu,!0)}]}]})}